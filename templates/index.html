<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medication Reminder System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-on {
            background-color: #2ecc71;
        }
        .status-off {
            background-color: #e74c3c;
        }
        .card {
            background-color: #fff;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 20px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, button {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        button.danger {
            background-color: #e74c3c;
        }
        button.danger:hover {
            background-color: #c0392b;
        }
        button.success {
            background-color: #2ecc71;
        }
        button.success:hover {
            background-color: #27ae60;
        }
        .compartment {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .compartment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .log-container {
            height: 300px;
            overflow-y: auto;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
        }
        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .log-timestamp {
            color: #7f8c8d;
            font-size: 0.8em;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        .tab.active {
            background-color: #fff;
            border-color: #ddd;
            border-bottom-color: #fff;
            margin-bottom: -1px;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Medication Reminder System</h1>
            <div>
                <span class="status-indicator" id="system-status-indicator"></span>
                <span id="system-status-text">Loading...</span>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="dashboard">Dashboard</div>
            <div class="tab" data-tab="medication">Medication Settings</div>
            <div class="tab" data-tab="system">System Settings</div>
            <div class="tab" data-tab="logs">System Logs</div>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard">
            <div class="card">
                <h2>System Overview</h2>
                <p><strong>Current Time:</strong> <span id="current-time">Loading...</span></p>
                <div class="grid">
                    <div class="compartment">
                        <div class="compartment-header">
                            <h3>Compartment 1</h3>
                            <span id="compartment1-status">Unknown</span>
                        </div>
                        <p><strong>Medication Times:</strong> <span id="compartment1-times">Loading...</span></p>
                        <p><strong>Status:</strong> <span id="compartment1-taken">Unknown</span></p>
                        <div>
                            <button onclick="openCompartment(1)" class="success">Open</button>
                            <button onclick="closeCompartment(1)" class="danger">Close</button>
                        </div>
                    </div>
                    <div class="compartment">
                        <div class="compartment-header">
                            <h3>Compartment 2</h3>
                            <span id="compartment2-status">Unknown</span>
                        </div>
                        <p><strong>Medication Times:</strong> <span id="compartment2-times">Loading...</span></p>
                        <p><strong>Status:</strong> <span id="compartment2-taken">Unknown</span></p>
                        <div>
                            <button onclick="openCompartment(2)" class="success">Open</button>
                            <button onclick="closeCompartment(2)" class="danger">Close</button>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button id="system-toggle-btn" onclick="toggleSystem()">Start System</button>
                    <button onclick="testBuzzer()">Test Buzzer</button>
                </div>
            </div>
        </div>

        <!-- Medication Settings Tab -->
        <div class="tab-content" id="medication">
            <div class="card">
                <h2>Set Medication Times</h2>
                <div class="grid">
                    <div class="compartment">
                        <h3>Compartment 1</h3>
                        <div class="form-group">
                            <label>Slot 1</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="comp1-slot1-hour" min="0" max="23" placeholder="Hour (0-23)">
                                <input type="number" id="comp1-slot1-minute" min="0" max="59" placeholder="Minute (0-59)">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Slot 2</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="comp1-slot2-hour" min="0" max="23" placeholder="Hour (0-23)">
                                <input type="number" id="comp1-slot2-minute" min="0" max="59" placeholder="Minute (0-59)">
                            </div>
                        </div>
                        <button onclick="setMedicationTime(1, 1)">Set Slot 1</button>
                        <button onclick="setMedicationTime(1, 2)">Set Slot 2</button>
                    </div>
                    <div class="compartment">
                        <h3>Compartment 2</h3>
                        <div class="form-group">
                            <label>Slot 1</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="comp2-slot1-hour" min="0" max="23" placeholder="Hour (0-23)">
                                <input type="number" id="comp2-slot1-minute" min="0" max="59" placeholder="Minute (0-59)">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Slot 2</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="comp2-slot2-hour" min="0" max="23" placeholder="Hour (0-23)">
                                <input type="number" id="comp2-slot2-minute" min="0" max="59" placeholder="Minute (0-59)">
                            </div>
                        </div>
                        <button onclick="setMedicationTime(2, 1)">Set Slot 1</button>
                        <button onclick="setMedicationTime(2, 2)">Set Slot 2</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Settings Tab -->
        <div class="tab-content" id="system">
            <div class="card">
                <h2>Set System Time</h2>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="rtc-date">
                </div>
                <div class="form-group">
                    <label>Time</label>
                    <input type="time" id="rtc-time" step="1">
                </div>
                <button onclick="setRTCTime()">Set System Time</button>
            </div>
        </div>

        <!-- Logs Tab -->
        <div class="tab-content" id="logs">
            <div class="card">
                <h2>System Logs</h2>
                <div class="log-container" id="system-logs">
                    <div class="log-entry">
                        <span class="log-timestamp">Loading logs...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication credentials
        const username = 'admin';
        const password = 'password';

        // Global variables
        let systemRunning = false;
        let updateInterval;
        let authHeader = 'Basic ' + btoa(username + ':' + password);

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Fetch system status
        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) {
                    throw new Error('Failed to fetch status');
                }
                const data = await response.json();
                updateUI(data);
            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }

        // Update UI with status data
        function updateUI(data) {
            // Update system status
            systemRunning = data.system_running;
            const statusIndicator = document.getElementById('system-status-indicator');
            const statusText = document.getElementById('system-status-text');
            const systemToggleBtn = document.getElementById('system-toggle-btn');
            
            if (systemRunning) {
                statusIndicator.className = 'status-indicator status-on';
                statusText.textContent = 'System Running';
                systemToggleBtn.textContent = 'Stop System';
                systemToggleBtn.className = 'danger';
            } else {
                statusIndicator.className = 'status-indicator status-off';
                statusText.textContent = 'System Stopped';
                systemToggleBtn.textContent = 'Start System';
                systemToggleBtn.className = 'success';
            }
            
            // Update current time
            document.getElementById('current-time').textContent = data.rtc_time;
            
            // Update compartment 1 info
            document.getElementById('compartment1-times').textContent = 
                `${data.medication_times[0][0][0].toString().padStart(2, '0')}:${data.medication_times[0][0][1].toString().padStart(2, '0')} & ${data.medication_times[0][1][0].toString().padStart(2, '0')}:${data.medication_times[0][1][1].toString().padStart(2, '0')}`;
            document.getElementById('compartment1-taken').textContent = data.medication_taken[0] ? 'Medication Taken' : 'Waiting for Medication';
            document.getElementById('compartment1-status').textContent = data.compartment_open[0] ? 'Open' : 'Closed';
            
            // Update compartment 2 info
            document.getElementById('compartment2-times').textContent = 
                `${data.medication_times[1][0][0].toString().padStart(2, '0')}:${data.medication_times[1][0][1].toString().padStart(2, '0')} & ${data.medication_times[1][1][0].toString().padStart(2, '0')}:${data.medication_times[1][1][1].toString().padStart(2, '0')}`;
            document.getElementById('compartment2-taken').textContent = data.medication_taken[1] ? 'Medication Taken' : 'Waiting for Medication';
            document.getElementById('compartment2-status').textContent = data.compartment_open[1] ? 'Open' : 'Closed';
            
            // Update logs
            const logsContainer = document.getElementById('system-logs');
            logsContainer.innerHTML = '';
            data.system_messages.forEach(msg => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `<span class="log-timestamp">${msg.timestamp}</span> ${msg.message}`;
                logsContainer.appendChild(logEntry);
            });
            
            // Auto-scroll logs to bottom
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // Toggle system (start/stop)
        async function toggleSystem() {
            try {
                const endpoint = systemRunning ? '/api/stop_system' : '/api/start_system';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authHeader
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to toggle system');
                }
                
                fetchStatus();
            } catch (error) {
                console.error('Error toggling system:', error);
                alert('Error: ' + error.message);
            }
        }

        // Open compartment
        async function openCompartment(compartment) {
            try {
                const response = await fetch('/api/open_compartment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authHeader
                    },
                    body: JSON.stringify({ compartment })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to open compartment');
                }
                
                setTimeout(fetchStatus, 1000);
            } catch (error) {
                console.error('Error opening compartment:', error);
                alert('Error: ' + error.message);
            }
        }

        // Close compartment
        async function closeCompartment(compartment) {
            try {
                const response = await fetch('/api/close_compartment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authHeader
                    },
                    body: JSON.stringify({ compartment })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to close compartment');
                }
                
                setTimeout(fetchStatus, 1000);
            } catch (error) {
                console.error('Error closing compartment:', error);
                alert('Error: ' + error.message);
            }
        }

        // Test buzzer
        async function testBuzzer() {
            try {
                const response = await fetch('/api/test_buzzer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authHeader
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to test buzzer');
                }
            } catch (error) {
                console.error('Error testing buzzer:', error);
                alert('Error: ' + error.message);
            }
        }

        // Set medication time
        async function setMedicationTime(compartment, slot) {
            try {
                const hourInput = document.getElementById(`comp${compartment}-slot${slot}-hour`);
                const minuteInput = document.getElementById(`comp${compartment}-slot${slot}-minute`);
                
                const hour = parseInt(hourInput.value);
                const minute = parseInt(minuteInput.value);
                
                if (isNaN(hour) || isNaN(minute) || hour < 0 || hour > 23 || minute < 0 || minute > 59) {
                    alert('Please enter valid hour (0-23) and minute (0-59)');
                    return;
                }
                
                const response = await fetch('/api/set_medication_time', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authHeader
                    },
                    body: JSON.stringify({ compartment, slot, hour, minute })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to set medication time');
                }
                
                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    fetchStatus();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error setting medication time:', error);
                alert('Error: ' + error.message);
            }
        }

        // Set RTC time
        async function setRTCTime() {
            try {
                const dateInput = document.getElementById('rtc-date');
                const timeInput = document.getElementById('rtc-time');
                
                if (!dateInput.value || !timeInput.value) {
                    alert('Please enter both date and time');
                    return;
                }
                
                const dateObj = new Date(dateInput.value + 'T' + timeInput.value);
                
                if (isNaN(dateObj.getTime())) {
                    alert('Please enter valid date and time');
                    return;
                }
                
                const year = dateObj.getFullYear();
                const month = dateObj.getMonth() + 1;
                const day = dateObj.getDate();
                const hour = dateObj.getHours();
                const minute = dateObj.getMinutes();
                const second = dateObj.getSeconds();
                
                const response = await fetch('/api/set_rtc_time', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authHeader
                    },
                    body: JSON.stringify({ year, month, day, hour, minute, second })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to set RTC time');
                }
                
                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    fetchStatus();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error setting RTC time:', error);
                alert('Error: ' + error.message);
            }
        }

        // Initialize the page
        function init() {
            // Set current date and time in the RTC form
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0];
            
            document.getElementById('rtc-date').value = dateStr;
            document.getElementById('rtc-time').value = timeStr;
            
            // Fetch initial status
            fetchStatus();
            
            // Set up periodic status updates
            updateInterval = setInterval(fetchStatus, 5000);
        }

        // Call init when the page loads
        window.addEventListener('load', init);
        
        // Clean up when the page unloads
        window.addEventListener('beforeunload', () => {
            clearInterval(updateInterval);
        });
    </script>
</body>
</html>
